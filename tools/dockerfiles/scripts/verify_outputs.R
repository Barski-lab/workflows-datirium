#!/usr/bin/env Rscript
#
# Script to verify that all output files defined in CWL files
# are correctly generated by the corresponding R scripts
#

# Load required utility functions
source_dir <- function(path) {
  files <- list.files(path, pattern = "\\.R$", full.names = TRUE)
  for (file in files) {
    source(file)
  }
}

# Source common functions
if (file.exists("functions/common/output_utils.R")) {
  source("functions/common/output_utils.R")
} else if (file.exists("/usr/local/bin/functions/common/output_utils.R")) {
  source("/usr/local/bin/functions/common/output_utils.R")
} else {
  stop("Could not find output_utils.R")
}

# Define CWL output specifications
deseq_advanced_outputs <- list(
  diff_expr_file = list(
    glob = "*report.tsv",
    expected_format = "TSV",
    description = "Differential expression results"
  ),
  deseq_summary_md = list(
    glob = "*summary.md",
    expected_format = "Markdown",
    description = "Analysis summary"
  ),
  read_counts_file_all = list(
    glob = "*counts_all.gct",
    expected_format = "GCT",
    description = "All normalized read counts"
  ),
  read_counts_file_filtered = list(
    glob = "*counts_filtered.gct",
    expected_format = "GCT",
    description = "Filtered normalized read counts"
  ),
  phenotypes_file = list(
    glob = "*phenotypes.cls",
    expected_format = "CLS",
    description = "Sample phenotypes for GSEA"
  ),
  plot_lfc_vs_mean = list(
    glob = "*_ma_plot.png",
    expected_format = "PNG",
    description = "MA plot"
  ),
  gene_expr_heatmap = list(
    glob = "*_expression_heatmap.png",
    expected_format = "PNG",
    description = "Gene expression heatmap"
  ),
  plot_pca = list(
    glob = "*_pca_plot.png",
    expected_format = "PNG",
    description = "PCA plot"
  ),
  plot_lfc_vs_mean_pdf = list(
    glob = "*_ma_plot.pdf",
    expected_format = "PDF",
    description = "MA plot (PDF)"
  ),
  gene_expr_heatmap_pdf = list(
    glob = "*_expression_heatmap.pdf",
    expected_format = "PDF",
    description = "Gene expression heatmap (PDF)"
  ),
  plot_pca_pdf = list(
    glob = "*_pca_plot.pdf",
    expected_format = "PDF",
    description = "PCA plot (PDF)"
  ),
  mds_plot_html = list(
    glob = "*_mds_plot.html",
    expected_format = "HTML",
    description = "MDS plot"
  )
)

lrt_step1_outputs <- list(
  contrasts_table = list(
    glob = "*_contrasts_table.tsv",
    expected_format = "TSV",
    description = "Contrasts definition table"
  ),
  dsq_obj_data = list(
    glob = "*_contrasts.rds",
    expected_format = "RDS",
    description = "DESeq2 object data"
  ),
  lrt_diff_expr = list(
    glob = "*_gene_exp_table.tsv",
    expected_format = "TSV",
    description = "LRT differential expression results"
  ),
  mds_plots_html = list(
    glob = "*_mds_plot.html",
    expected_format = "HTML",
    description = "MDS plot"
  ),
  mds_plots_corrected_html = list(
    glob = "*_mds_plot_corrected.html",
    expected_format = "HTML",
    description = "Batch-corrected MDS plot"
  ),
  counts_all_gct = list(
    glob = "*_counts_all.gct",
    expected_format = "GCT",
    description = "All normalized read counts"
  ),
  counts_filtered_gct = list(
    glob = "*_counts_filtered.gct",
    expected_format = "GCT",
    description = "Filtered normalized read counts"
  ),
  lrt_summary_md = list(
    glob = "*_lrt_result.md",
    expected_format = "Markdown",
    description = "LRT results summary"
  ),
  alignment_stats_barchart = list(
    glob = "alignment_stats_barchart.png",
    expected_format = "PNG",
    description = "Alignment statistics bar chart"
  )
)

lrt_step2_outputs <- list(
  diff_expr_files = list(
    glob = "*_gene_exp_table.tsv",
    expected_format = "TSV",
    description = "Differential expression results for contrasts"
  ),
  mds_plots_html = list(
    glob = "mds_plot.html",
    expected_format = "HTML",
    description = "MDS plot"
  ),
  counts_all_gct = list(
    glob = "counts_all.gct",
    expected_format = "GCT",
    description = "All normalized read counts"
  ),
  counts_filtered_gct = list(
    glob = "counts_filtered.gct",
    expected_format = "GCT",
    description = "Filtered normalized read counts"
  )
)

# Sample data to test output generation
test_prefix <- "test_output"
test_data <- matrix(
  runif(100), nrow = 10, ncol = 10,
  dimnames = list(
    paste0("gene", 1:10),
    paste0("sample", 1:10)
  )
)
test_classes <- rep(c("A", "B"), each = 5)

# Test GCT file generation
write_gct_file(test_data, get_output_filename(test_prefix, "counts_all", "gct"))
cat("✓ GCT file creation works\n")

# Test CLS file generation
write_cls_file(test_classes, get_output_filename(test_prefix, "phenotypes", "cls"))
cat("✓ CLS file creation works\n")

# Test plot saving
if (requireNamespace("ggplot2", quietly = TRUE)) {
  test_plot <- ggplot2::ggplot(data.frame(x = 1:10, y = 1:10), ggplot2::aes(x, y)) +
    ggplot2::geom_point()
  
  plot_files <- save_plot(test_plot, test_prefix, "test_plot")
  
  if (file.exists(plot_files$png) && file.exists(plot_files$pdf)) {
    cat("✓ Plot saving in multiple formats works\n")
  } else {
    cat("✗ Plot saving failed\n")
  }
}

# Test markdown file creation
write_markdown_summary(c("# Test Summary", "", "This is a test"), 
                      get_output_filename(test_prefix, "summary", "md"))
cat("✓ Markdown file creation works\n")

# Print summary of output specifications
cat("\nOutput specifications summary:\n")
cat("----------------------------\n")

cat("\ndeseq-advanced.cwl outputs:\n")
for (name in names(deseq_advanced_outputs)) {
  cat(sprintf("  - %s: %s (%s)\n", 
             name, 
             deseq_advanced_outputs[[name]]$description,
             deseq_advanced_outputs[[name]]$glob))
}

cat("\ndeseq-lrt-step-1.cwl outputs:\n")
for (name in names(lrt_step1_outputs)) {
  cat(sprintf("  - %s: %s (%s)\n", 
             name, 
             lrt_step1_outputs[[name]]$description,
             lrt_step1_outputs[[name]]$glob))
}

cat("\ndeseq-lrt-step-2.cwl outputs:\n")
for (name in names(lrt_step2_outputs)) {
  cat(sprintf("  - %s: %s (%s)\n", 
             name, 
             lrt_step2_outputs[[name]]$description,
             lrt_step2_outputs[[name]]$glob))
}

# Clean up test files
for (file in unlist(plot_files)) {
  if (file.exists(file)) file.remove(file)
}
file.remove(get_output_filename(test_prefix, "counts_all", "gct"),
            get_output_filename(test_prefix, "phenotypes", "cls"),
            get_output_filename(test_prefix, "summary", "md"))
cat("\nTest files cleaned up\n")

cat("\nAll output utility functions are working correctly\n")

#' Verify all required outputs for a specific workflow
#'
#' @param workflow_type Type of workflow ("deseq_advanced", "lrt_step1", or "lrt_step2")
#' @param output_prefix Output prefix used in the workflow
#' @param fail_on_missing Whether to stop execution if outputs are missing
#' @return Logical indicating if all outputs exist
#' @export
verify_workflow_outputs <- function(workflow_type, output_prefix, fail_on_missing = TRUE) {
  cat(paste0("Verifying outputs for workflow: ", workflow_type, "\n"))
  
  # Determine which output specifications to use
  output_specs <- switch(workflow_type,
    "deseq_advanced" = deseq_advanced_outputs,
    "lrt_step1" = lrt_step1_outputs,
    "lrt_step2" = lrt_step2_outputs,
    stop("Unknown workflow type: ", workflow_type)
  )
  
  # Build list of expected files
  expected_files <- list()
  
  for (name in names(output_specs)) {
    # Get the glob pattern and replace * with output_prefix
    glob <- output_specs[[name]]$glob
    file_pattern <- gsub("\\*", output_prefix, glob)
    
    # For patterns without asterisks, use them directly
    if (!grepl("\\*", glob)) {
      expected_files[[name]] <- glob
    } else {
      expected_files[[name]] <- file_pattern
    }
  }
  
  # Check if files exist using our consolidated verify_outputs function
  return(verify_outputs(output_prefix, gsub("_advanced", "", workflow_type), fail_on_missing))
}

# Example of how to use the verification function at the end of a workflow:
# 
# # At the end of a DESeq Advanced workflow
# verify_workflow_outputs("deseq_advanced", "my_output_prefix")
# 
# # At the end of a DESeq LRT Step 1 workflow
# verify_workflow_outputs("lrt_step1", "my_step1_prefix")
# 
# # At the end of a DESeq LRT Step 2 workflow
# verify_workflow_outputs("lrt_step2", "my_step2_prefix")

# Instructions for workflow script authors:
cat("\nInstructions for workflow script authors:\n")
cat("To verify outputs at the end of your workflow script, add:\n")
cat("  source('verify_outputs.R')\n")
cat("  verify_workflow_outputs(\"workflow_type\", output_prefix)\n")
cat("Where workflow_type is one of: \"deseq_advanced\", \"lrt_step1\", or \"lrt_step2\"\n")
cat("And output_prefix is the prefix used for output files in your workflow\n") 